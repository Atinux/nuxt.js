<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0">
  <title>Building</title>
</head>
<body>

<pre id="main"></pre>

<script>
var data = __DATA__

var _reconnectTimer
function reconnect() {
  if (_reconnectTimer) {
    clearTimeout(_reconnectTimer)
  }
  setTimeout(async () => {
    try {
      await connect()
    } catch(e) {
      reconnect()
    }
   }, 1000)
}

function connect() {
  return new Promise((resolve, reject) => {
    const ws = new WebSocket(location.href.replace('http://', 'ws://') + '/ws')

    ws.onmessage = (message) => {
      data = JSON.parse(message.data)
      render()
    }

    ws.onclose = () => { reconnect() }
    ws.onerror = (error) => reject(error)
    ws.onopen = () => resolve()
  })
}

function render() {
  main.innerHTML = JSON.stringify(data, null, 2)
}

main = document.getElementById('main')
render()

connect()
</script>
</body>
</html>
